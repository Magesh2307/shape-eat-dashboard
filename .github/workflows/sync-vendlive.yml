# .github/workflows/sync-vendlive.yml
name: 🔄 Sync VendLive → Supabase

on:
  schedule:
    # Rush du matin (7h-10h) : toutes les 30 min
    - cron: '*/30 7-10 * * *'
    
    # Rush du midi (11h-14h) : toutes les 20 min
    - cron: '*/20 11-14 * * *'
    
    # Après-midi (15h-18h) : toutes les heures
    - cron: '5 15-18 * * *'
    
    # Soirée (19h-22h) : toutes les heures
    - cron: '5 19-22 * * *'
    
    # Nuit (23h et 6h) : 2 fois seulement
    - cron: '0 23,6 * * *'
  
  # Permet le lancement manuel
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Nombre de jours à synchroniser'
        required: false
        default: '1'

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v3
    
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: 📦 Install dependencies
      run: |
        npm install @supabase/supabase-js
        npm install -D tsx @types/node
    
    - name: 🕐 Check sync time
      id: time_check
      run: |
        HOUR=$(date +%H)
        echo "current_hour=$HOUR" >> $GITHUB_OUTPUT
        echo "🕐 Sync à $(date '+%H:%M') (heure serveur)"
    
    - name: 🔄 Run synchronization
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SYNC_DAYS: ${{ github.event.inputs.days_back || '1' }}
      run: |
        echo "🚀 Démarrage de la synchronisation..."
        npx tsx scripts/sync-vendlive.ts
    
    - name: 📊 Generate sync report
      if: success()
      run: |
        echo "✅ Synchronisation réussie à $(date '+%H:%M')"
        echo "📈 Prochaine sync dans : "
        HOUR=$(date +%H)
        if [ $HOUR -ge 7 ] && [ $HOUR -lt 10 ]; then
          echo "30 minutes (période rush matin)"
        elif [ $HOUR -ge 11 ] && [ $HOUR -lt 14 ]; then
          echo "20 minutes (période rush midi)"
        else
          echo "1 heure (période normale)"
        fi
    
    - name: 🚨 Notification en cas d'erreur
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '🚨 Échec de la synchronisation VendLive',
            body: `La synchronisation a échoué le ${new Date().toLocaleString('fr-FR')}.\n\nVoir les [logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
          })