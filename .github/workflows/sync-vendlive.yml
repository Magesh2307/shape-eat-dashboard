name: ðŸ”„ Sync VendLive â†’ Supabase

on:
  schedule:
    - cron: '5 7-22 * * *' # toutes les heures 07:05â†’22:05 (UTC)
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          npm i -D tsx
          npm i dotenv

      - name: ðŸ”„ Run synchronization
        env:
          # âœ… ces noms correspondent Ã  ton script sync-vendlive.ts
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

          VENDLIVE_API_URL: https://vendlive.com/api/2.0/order-sales/
          VENDLIVE_ACCOUNT_ID: "295"
          VENDLIVE_TOKEN: ${{ secrets.VENDLIVE_TOKEN }}

          # FenÃªtre + tri (sÃ»r par dÃ©faut)
          SYNC_MODE: full
          SYNC_START_DATE: "2024-01-01"
          SYNC_END_DATE: ${{ steps.tomorrow.outputs.value }}
          MAX_PAGES: "0"
          ORDER_BY: -created_at
        run: npx tsx scripts/sync-vendlive.ts

      - name: ðŸ“… Compute tomorrow (ISO)
        id: tomorrow
        run: echo "value=$(date -u -d 'tomorrow' +%F)" >> $GITHUB_OUTPUT
