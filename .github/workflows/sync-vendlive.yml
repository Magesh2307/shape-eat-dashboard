name: üîÑ Sync VendLive ‚Üí Supabase
on:
  schedule:
    - cron: '5 7-22 * * *' # toutes les heures 07:05‚Üí22:05 (UTC)
  workflow_dispatch:
permissions:
  contents: read
jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # ‚Üê Augment√© car 6 comptes
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: üì¶ Install dependencies
        run: |
          npm ci
          npm i -D tsx
          npm i dotenv
      
      - name: üìÖ Compute tomorrow (ISO)
        id: tomorrow
        run: echo "value=$(date -u -d 'tomorrow' +%F)" >> $GITHUB_OUTPUT
      
      - name: üîÑ Run synchronization
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          VENDLIVE_API_URL: https://vendlive.com/api/2.0/order-sales/
          VENDLIVE_ACCOUNT_IDS: ${{ secrets.VENDLIVE_ACCOUNT_IDS }}  # ‚Üê Chang√©
          VENDLIVE_TOKEN: ${{ secrets.VENDLIVE_TOKEN }}
          SYNC_MODE: full
          SYNC_START_DATE: "2024-01-01"
          SYNC_END_DATE: ${{ steps.tomorrow.outputs.value }}
          MAX_PAGES: "0"
          ORDER_BY: -created_at
        run: npx tsx scripts/sync-vendlive.ts