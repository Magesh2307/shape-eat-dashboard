# .github/workflows/sync-vendlive.yml
name: ğŸ”„ Sync VendLive â†’ Supabase

on:
  schedule:
    # Rush du matin (7h-10h) : toutes les 30 min
    - cron: '*/30 7-10 * * *'
    
    # Rush du midi (11h-14h) : toutes les 20 min
    - cron: '*/20 11-14 * * *'
    
    # AprÃ¨s-midi (15h-18h) : toutes les heures
    - cron: '5 15-18 * * *'
    
    # SoirÃ©e (19h-22h) : toutes les heures
    - cron: '5 19-22 * * *'
    
    # Nuit (23h et 6h) : 2 fois seulement
    - cron: '0 23,6 * * *'
  
  # Permet le lancement manuel
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Nombre de jours Ã  synchroniser'
        required: false
        default: '1'

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        npm install @supabase/supabase-js
        npm install -D tsx @types/node
    
    - name: ğŸ• Check sync time
      id: time_check
      run: |
        HOUR=$(date +%H)
        echo "current_hour=$HOUR" >> $GITHUB_OUTPUT
        echo "ğŸ• Sync Ã  $(date '+%H:%M') (heure serveur)"
    
    - name: ğŸ”„ Run synchronization
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SYNC_DAYS: ${{ github.event.inputs.days_back || '1' }}
      run: |
        echo "ğŸš€ DÃ©marrage de la synchronisation..."
        npx tsx scripts/sync-vendlive.ts
    
    - name: ğŸ“Š Generate sync report
      if: success()
      run: |
        echo "âœ… Synchronisation rÃ©ussie Ã  $(date '+%H:%M')"
        echo "ğŸ“ˆ Prochaine sync dans : "
        HOUR=$(date +%H)
        if [ $HOUR -ge 7 ] && [ $HOUR -lt 10 ]; then
          echo "30 minutes (pÃ©riode rush matin)"
        elif [ $HOUR -ge 11 ] && [ $HOUR -lt 14 ]; then
          echo "20 minutes (pÃ©riode rush midi)"
        else
          echo "1 heure (pÃ©riode normale)"
        fi
    
    - name: ğŸš¨ Notification en cas d'erreur
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ Ã‰chec de la synchronisation VendLive',
            body: `La synchronisation a Ã©chouÃ© le ${new Date().toLocaleString('fr-FR')}.\n\nVoir les [logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
          })